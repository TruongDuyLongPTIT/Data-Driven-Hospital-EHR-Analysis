-- Kết nối vào Trino
docker exec -it trino trino

-- Show các catalogs
SHOW CATALOGS;

-- Show các schemas trong catalogs
SHOW SCHEMAS in iceberg; 
(iceberg là tên catalogs)

-- Create 1 schema mới tên là mimic_trino
CREATE SCHEMA iceberg.mimic_trino;

-- Sử dụng schema mimic
USE iceberg.mimic_trino;

-- Register vào đúng schema mimic_trino
CALL iceberg.system.register_table(
    schema_name => 'mimic_trino',
    table_name => 'fact_icu_vital_sign_event',
    table_location => 's3://mimic-lakehouse/gold/factICUVitalSignEvent'
);

CALL iceberg.system.register_table(
    schema_name => 'mimic_trino',
    table_name => 'dim_time',
    table_location => 's3://mimic-lakehouse/gold/dim_time'
);

CALL iceberg.system.register_table(
    schema_name => 'mimic_trino',
    table_name => 'dim_event_type',
    table_location => 's3://mimic-lakehouse/gold/dimEventType'
);

CALL iceberg.system.register_table(
    schema_name => 'mimic_trino',
    table_name => 'dim_icu_stay',
    table_location => 's3://mimic-lakehouse/gold/dimICUStay'
);

CALL iceberg.system.register_table(
    schema_name => 'mimic_trino',
    table_name => 'dim_patient',
    table_location => 's3://mimic-lakehouse/gold/dimPatient'
);

-- Kiểm tra lại
SHOW TABLES IN iceberg.mimic_trino;

-- Test query
SELECT * FROM fact_icu_vital_sign_event LIMIT 10;

SELECT * FROM fact_icu_vital_sign_event WHERE subject_id = 16723035;


-- Lấy BP data với 3 đường: systolic, diastolic, mean
trino --execute
"SELECT 
    dp.subject_id,
    dp.age,
    dp.gender,
    dt.full_datetime,                  
    dt.day_of_month,
	dt.hour_minute,
    dt.hour,
    dt.minute,
	di.stay_id,
    CASE 
        WHEN f.itemid = 220050 THEN 'systolic'
        WHEN f.itemid = 220051 THEN 'diastolic'
        WHEN f.itemid = 220052 THEN 'mean'
    END as bp_type,
    f.value_of_measurements as bp_value,
    f.unit_of_measurements as unit
FROM fact_icu_vital_sign_event f
JOIN dim_patient dp ON f.subject_id = dp.subject_id
JOIN dim_icu_stay di ON f.stay_id = di.stay_id
JOIN dim_event_type de ON f.itemid = de.itemid
JOIN dim_time dt ON f.timekey = dt.timekey
WHERE dp.subject_id = 10045991 AND di.stay_id = 34889777 and de.itemid in (220050, 220051, 220052)
ORDER BY dt.full_datetime, f.itemid" --output-format CSV > /tmp/blood_pressure.csv;

------------ Connect Trino with Tableau---------
jdbc:trino://localhost:8084/iceberg/mimic_trino


DROP SCHEMA iceberg.mimic_trino CASCADE;
